<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calorie Scanner</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    #video-container { display: none; }
  </style>
</head>

<body class="bg-gray-900 text-white min-h-screen">

<div class="max-w-2xl mx-auto p-4 space-y-6">

  <header class="text-center">
    <h1 class="text-3xl font-bold text-blue-400">Calorie Scanner</h1>
    <p class="text-gray-400">Log your food by scanning barcodes</p>
  </header>

  <!-- Scanner -->
  <section class="bg-gray-800 p-4 rounded-lg space-y-4">
    <h2 class="text-xl font-semibold">Scan Barcode</h2>

    <button id="startBtn"
      class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-bold">
      Start Camera
    </button>

    <p id="scannerMsg" class="text-yellow-400 text-sm text-center"></p>

    <div id="video-container" class="rounded-lg overflow-hidden">
      <video id="video" autoplay playsinline muted class="w-full"></video>
    </div>

    <div class="flex gap-2">
      <input id="manualInput"
        class="flex-1 bg-gray-700 px-3 py-2 rounded-lg text-white"
        placeholder="Enter barcode manually" />
      <button id="manualBtn"
        class="bg-green-600 px-4 py-2 rounded-lg font-bold">
        Find
      </button>
    </div>
  </section>

  <!-- Status -->
  <p id="status" class="text-center text-gray-400"></p>

  <!-- Product -->
  <section id="productBox"
    class="bg-gray-800 p-4 rounded-lg hidden space-y-2">
  </section>

</div>

<script>
/* -------------------- DOM -------------------- */
const startBtn = document.getElementById("startBtn");
const video = document.getElementById("video");
const videoContainer = document.getElementById("video-container");
const manualInput = document.getElementById("manualInput");
const manualBtn = document.getElementById("manualBtn");
const statusEl = document.getElementById("status");
const productBox = document.getElementById("productBox");
const scannerMsg = document.getElementById("scannerMsg");

let stream = null;
let detector = null;

/* -------------------- Scanner Support -------------------- */
if (!("BarcodeDetector" in window)) {
  scannerMsg.textContent =
    "Camera scanning works on mobile Chrome only. Use manual entry on desktop.";
  startBtn.disabled = true;
  startBtn.classList.add("opacity-50");
} else {
  detector = new BarcodeDetector({
    formats: ["ean_13", "upc_a", "ean_8"]
  });
}

/* -------------------- Camera -------------------- */
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
    video.srcObject = stream;
    videoContainer.style.display = "block";
    statusEl.textContent = "Point camera at barcode…";
    scanLoop();
  } catch (e) {
    statusEl.textContent = "Camera permission denied.";
  }
}

function stopCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  videoContainer.style.display = "none";
}

/* -------------------- Scan Loop -------------------- */
async function scanLoop() {
  if (!stream) return;
  try {
    const codes = await detector.detect(video);
    if (codes.length) {
      stopCamera();
      lookupBarcode(codes[0].rawValue);
    } else {
      requestAnimationFrame(scanLoop);
    }
  } catch {
    requestAnimationFrame(scanLoop);
  }
}

/* -------------------- Barcode Lookup -------------------- */
async function lookupBarcode(barcode) {
  statusEl.textContent = "Looking up product…";
  productBox.classList.add("hidden");

  try {
    const res = await fetch(
      `https://world.openfoodfacts.org/api/v2/product/${barcode}.json`
    );
    const data = await res.json();

    if (!data.product) {
      statusEl.textContent = "Product not found.";
      return;
    }

    const p = data.product;
    const n = p.nutriments || {};

    let calories = NaN;

    if (n["energy-kcal_serving"])
      calories = parseFloat(n["energy-kcal_serving"]);
    else if (n["energy-kcal_100g"])
      calories = parseFloat(n["energy-kcal_100g"]);
    else if (n["energy"])
      calories = parseFloat(n["energy"]) / 4.184;

    const name =
      p.product_name_en || p.product_name || "Unknown product";

    productBox.innerHTML = `
      <h3 class="text-lg font-bold">${name}</h3>
      <p class="text-2xl text-blue-300 font-bold">
        ${isNaN(calories) ? "Calories unavailable" : calories.toFixed(0) + " kcal"}
      </p>
      <p class="text-sm text-gray-400">Barcode: ${barcode}</p>
    `;

    productBox.classList.remove("hidden");
    statusEl.textContent = "Product found.";

  } catch {
    statusEl.textContent = "Network error.";
  }
}

/* -------------------- Events -------------------- */
startBtn.onclick = startCamera;
manualBtn.onclick = () => {
  if (manualInput.value.trim())
    lookupBarcode(manualInput.value.trim());
};
</script>

</body>
</html>
