<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Scanner</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #video-container {
            display: none;
            position: relative;
        }
        #video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: #374151;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-900 text-white h-full overflow-y-auto">

<div class="container mx-auto max-w-2xl p-4 space-y-6">

    <header class="text-center">
        <h1 class="text-3xl font-bold text-blue-400">Calorie Scanner</h1>
        <p class="text-gray-400">Log your food by scanning barcodes.</p>
    </header>

    <!-- Scanner -->
    <section class="bg-gray-800 p-4 rounded-lg shadow-lg space-y-4">
        <h2 class="text-xl font-semibold">Scan Barcode</h2>

        <div class="flex gap-4">
            <button id="start-scan-btn"
                class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-bold">
                Start Camera
            </button>
            <button id="stop-scan-btn"
                class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded-lg font-bold"
                style="display:none;">
                Stop Camera
            </button>
        </div>

        <p id="scanner-support-status" class="text-sm text-yellow-400 text-center"></p>

        <div id="video-container" class="bg-gray-700 rounded-lg overflow-hidden">
            <video id="video" autoplay playsinline muted></video>
        </div>

        <div class="space-y-2">
            <label class="text-sm text-gray-300">Or Enter Barcode Manually:</label>
            <div class="flex gap-2">
                <input id="manual-barcode"
                    class="flex-grow bg-gray-700 px-3 py-2 rounded-lg"
                    placeholder="Enter barcode number..." />
                <button id="manual-lookup-btn"
                    class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-bold">
                    Find
                </button>
            </div>
        </div>
    </section>

    <div id="status-message" class="text-center text-gray-400 h-6"></div>

    <div id="product-info"
        class="bg-gray-800 p-4 rounded-lg shadow-lg hidden"></div>

</div>

<script type="module">
/* ---------------- GLOBALS ---------------- */
let barcodeDetector;
let videoStream;
let currentProduct = null;

/* ---------------- DOM ---------------- */
const startBtn = document.getElementById("start-scan-btn");
const stopBtn = document.getElementById("stop-scan-btn");
const video = document.getElementById("video");
const videoContainer = document.getElementById("video-container");
const manualInput = document.getElementById("manual-barcode");
const manualBtn = document.getElementById("manual-lookup-btn");
const statusEl = document.getElementById("status-message");
const productInfoEl = document.getElementById("product-info");
const supportMsg = document.getElementById("scanner-support-status");

/* ---------------- SCANNER SUPPORT ---------------- */
function checkScannerSupport() {
    if (!("BarcodeDetector" in window)) {
        supportMsg.textContent =
            "Camera scanner not supported on this browser. Use manual entry.";
        startBtn.disabled = true;
        startBtn.classList.add("opacity-50");
        return false;
    }
    barcodeDetector = new BarcodeDetector({
        formats: ["ean_13", "upc_a", "ean_8", "upc_e"]
    });
    return true;
}

/* ---------------- CAMERA ---------------- */
async function startScanner() {
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });
        video.srcObject = videoStream;
        videoContainer.style.display = "block";
        startBtn.style.display = "none";
        stopBtn.style.display = "block";
        statusEl.textContent = "Point camera at barcode...";
        detectBarcode();
    } catch {
        statusEl.textContent = "Camera permission denied.";
    }
}

function stopScanner() {
    if (videoStream) videoStream.getTracks().forEach(t => t.stop());
    videoContainer.style.display = "none";
    startBtn.style.display = "block";
    stopBtn.style.display = "none";
}

/* ---------------- BARCODE LOOP ---------------- */
async function detectBarcode() {
    if (!videoStream) return;
    try {
        const codes = await barcodeDetector.detect(video);
        if (codes.length) {
            stopScanner();
            lookupBarcode(codes[0].rawValue);
        } else {
            requestAnimationFrame(detectBarcode);
        }
    } catch {
        requestAnimationFrame(detectBarcode);
    }
}

/* ---------------- LOOKUP (FIXED) ---------------- */
async function lookupBarcode(barcode) {
    if (!barcode) return;

    statusEl.textContent = `Looking up barcode ${barcode}...`;
    productInfoEl.classList.add("hidden");

    try {
        const res = await fetch(
            `https://world.openfoodfacts.org/api/v2/product/${barcode}.json?fields=product_name_en,product_name,nutriments,serving_size`
        );
        const data = await res.json();

        if (data.status !== 1 || !data.product) {
            statusEl.textContent = "Product not found.";
            return;
        }

        const p = data.product;
        const n = p.nutriments || {};

        let calValue = NaN;

        if (n["energy-kcal_serving"]) calValue = parseFloat(n["energy-kcal_serving"]);
        else if (n["energy-kcal_100g"]) calValue = parseFloat(n["energy-kcal_100g"]);
        else if (n["energy-kcal_100ml"]) calValue = parseFloat(n["energy-kcal_100ml"]);
        else if (n["energy_100g"]) calValue = parseFloat(n["energy_100g"]) / 4.184;
        else if (n["energy_100ml"]) calValue = parseFloat(n["energy_100ml"]) / 4.184;
        else if (n["energy"]) calValue = parseFloat(n["energy"]) / 4.184;

        const name =
            p.product_name_en ||
            p.product_name ||
            "Unknown product";

        const serving =
            p.serving_size ||
            (n["energy-kcal_100ml"] ? "100 ml" :
             n["energy-kcal_100g"] ? "100 g" : "N/A");

        productInfoEl.innerHTML = `
            <h3 class="text-lg font-bold">${name}</h3>
            <p class="text-2xl text-blue-300 font-bold">
                ${isNaN(calValue) ? "Calories unavailable" : calValue.toFixed(0) + " kcal"}
            </p>
            <p class="text-gray-400">Serving: ${serving}</p>
            <p class="text-sm text-gray-500">Barcode: ${barcode}</p>
        `;

        productInfoEl.classList.remove("hidden");
        statusEl.textContent = "Product found.";

    } catch {
        statusEl.textContent = "Error fetching product data.";
    }
}

/* ---------------- EVENTS ---------------- */
document.addEventListener("DOMContentLoaded", () => {
    checkScannerSupport();
    startBtn.onclick = startScanner;
    stopBtn.onclick = stopScanner;
    manualBtn.onclick = () => lookupBarcode(manualInput.value.trim());
});
</script>

</body>
</html>
